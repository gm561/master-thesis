
Let $hash:Q\rightarrow\{0,1,\dots, 2(h+v)-1\}$, then a set $P_{hash} \subseteq Q$,
defined with respect to $hash$, is the set of preimages of $0$ for $hash$.
The idea is that $P_{hash}$ contains $q \in Q$ on which $C$ is not allowed to ask hint queries,
and the first successful verification query $(q,y)$ of $C$ is such that $q \in P_{hash}$.
Therefore, if $C$ makes a verification query $(q,y)$ such that $q \in P_{hash}$, then we know that no hint query is ever asked on this $q$.
In the experiment $CanonicalSuccess$ a circuit $C$ succeeds if and only if it asks a successful verification query $(q,y)$ such that $q \in P_{hash}$,
and no hint query is asked on $q \in P_{hash}$.

In the experiment $CanonicalSuccess$ we denote the $i$-th query of $C$ by $q_i$ if it is a hint query, and by $(q_i, y_i)$
if it is a verification query.
%
\begin{codeblock}
  \textbf{Experiment $CanonicalSuccess^{P, C, hash}(\pi, \rho)$}
  \medskip

  \hrule

  \medskip
  \textbf{Oracle:} A problem poser $P$, a solver circuit $C = (C_1, C_2)$.\\
  \IndII A function $hash: Q \rightarrow \{0, \dots, 2(h+v) - 1\}$.\\
  \textbf{Input:}  Bitstrings $\pi \in \{0,1\}^n$ and $\rho \in \{0,1\}^*$. \\
  \textbf{Output:} A bit $b \in \{0,1\}$.

  \medskip\hrule\medskip
  Run $\langle P(\pi), C_1(\rho) \rangle$ \\
  \IndI $(\Gamma_V, \Gamma_H) := \langle P(\pi), C_1(\rho) \rangle_{P}$ \\
  \IndI $x := \langle P(\pi), C_1(\rho) \rangle_{\text{trans}}$ \\ \\
  Run $C_2^{\Gamma_V, \Gamma_H} (x, \rho)$ \\
  \IndI Let $(q_j,y_j)$ be the first verification query of $C_2$ such that $\Gamma_v(q_j, y_j) = 1$.\\
  \IndI If $C_2$ does not succeed let $(q_j, y_j)$ be an arbitrary verification query.\\
  \\
  \textbf{If} $(\forall i < j :  hash(q_i) = 0)$ \And $(hash(q_j) = 1)$ \And $(\Gamma_V(q_j, y_j) = 1)$ \then \\
  \IndI \textbf{return} 1\\
  \textbf{else}\\
  \IndI \textbf{return} 0
\end{codeblock}
%
We define \textit{the canonical success probability} of a solver $C$ for $P$ with respect to a function $hash$ as
\begin{align}
 \underset{\pi, \rho}{\Pr}[CanonicalSuccess^{P, C, hash}(\pi, \rho) = 1].
\end{align}
%
For fixed $hash$ and a problem poser $P$ a \textit{canonical success} of $C$ for $\pi, \rho$ is a situation where $CanonicalSuccess^{P, C, hash}(\pi, \rho) = 1$.

We show that if a solver circuit $C$ for $P^{(g)}$ often succeeds in the experiment $Success$, then it is
also often successful in the experiment $CanonicalSuccess$.

\begin{lemma}\textbf{(\boldmath{Success probability in solving a $k$-wise direct product of $P^{(1)}$ with respect to a function $hash$.)}}
\label{lemma:hash_function_probability}
For fixed $P^{(g)}$ let $C$ be a solver for $P^{(g)}$ with success probability at least $\gamma$,
asking at most $h$ hint queries and $v$ verification queries.
There exists a probabilistic algorithm \textbf{FindHash} that takes as input:
parameters $\gamma$, $n$, $k$, the number of verification queries $v$ and hint queries $h$, and has
oracle access to $C$ and $P^{(g)}$. Furthermore, \textbf{FindHash} runs in time $O((h+v)^4/\gamma^4)$,
and with high probability outputs a function $hash \in \cH$
such that the canonical success probability of $C$ with respect to $hash$ is at least $\frac{\gamma}{8(h+v)}$.
\end{lemma}
%
\begin{proof}
We fix $P^{(g)}$ and a solver $C$ for $P^{(g)}$ in the whole proof of Lemma \ref{lemma:hash_function_probability}.
Let $\cH$ be a family of pairwise independent hash functions $Q \rightarrow \{0,1, \dots,2(h+v)-1\}$.
For all $i,j \in \{1, \dots, (h+v)\}$ and $k,l \in \{0,1,\dots,2(h+v)-1\}$ by the pairwise independence property of $\cH$,
we have
\begin{align}
  \label{eq:hash_pr}
 \forall q_i,q_j \in Q, q_i \neq q_j : \underset{\textit{hash} \leftarrow \cH}{\Pr}[hash(q_i) = k \mid hash(q_j) = l] = \underset{\textit{hash} \leftarrow \cH}{\Pr}[hash(q_i) = k] = \frac{1}{2(h+v)}.
\end{align}
Let $\pi^{(k)}, \rho$ be fixed. We choose $hash \leftarrow \cH$ and consider the experiment $CanonicalSuccess^{P^{(g)}, C, hash}(\pi^{(k)}, \rho)$.
Let $X$ be a random variable for the event $hash(q_j) = 0$ and for every query $q_i$ asked before $q_j$  $hash(q_i) \neq 0$.
We get
\begin{align*}
  \underset{\textit{hash} \leftarrow \cH}{\Pr}[X=1]
  &= \underset{\textit{hash} \leftarrow \cH}{\Pr}[hash(q_j) = 0 \land (\forall i < j : hash(q_i) \neq 0)] \\
  &= \underset{\textit{hash} \leftarrow \cH}{\Pr}[\forall i < j : hash(q_i) \neq 0 \mid hash(q_j) = 0] \underset{\textit{hash} \leftarrow \cH}{\Pr}[hash(q_j) = 0] \\
  &\stackrel{(\ref{eq:hash_pr})}{=} \frac{1}{2(h+v)}\left(1 -\underset{\textit{hash} \leftarrow \cH}{\Pr}[\exists i < j : hash(q_i) = 0 \mid hash(q_j) = 0] \right) \\
  &\stackrel{(\ref{eq:hash_pr})}{=} \frac{1}{2(h+v)} \left( 1 -\underset{\textit{hash} \leftarrow \cH}{\Pr}[\exists i < j : hash(q_i) = 0] \right) \\
  &\stackrel{(\text{u.b})}{\geq} \frac{1}{2(h+v)} \left( 1 - \sum_{i < j} \underset{\textit{hash} \leftarrow \cH}{\Pr}[hash(q_i) = 0] \right) \\
  &\stackrel{(\ref{eq:hash_pr})}{\geq} \frac{1}{4(h+v)}.
\end{align*}
Let $\cP_{Success}$ be the set of all $(\pi^{(k)},\rho)$ for which $Success^{P^{(g)}, C}(\pi^{(k)}, \rho)$. Furthermore,
we denote the set of those $(\pi^{(k)},\rho)$ for which $CanonicalSuccess^{P^{(g)}, C(\cdot, \cdot), hash}(\pi^{(k)}, \rho) = 1$ by $\cP_{Canonical}$.
For fixed $(\pi^{(k)}, \rho)$ if $C$ succeeds canonically, then also $Success^{P^{(g)}, C}(\pi^{(k)}, \rho) = 1$.
Hence, $\cP_{Canonical} \subseteq \cP_{Success}$, and we conclude
\begin{align}
  \label{ineq:hash_high_prob}
\underset{\substack{\textit{hash} \leftarrow \cH \\ \pi^{(k)}, \rho}}{\Pr}\left[CanonicalSuccess^{P^{(g)}, C, hash}(\pi^{(k)}, \rho) = 1\right] &=
\underset{{(\pi^{(k)},\rho) \in \cP_{Success}}}{\mathbb{E}}\left[\underset{\substack{\textit{hash} \leftarrow \cH}}{\Pr}[X = 1]\right] \notag\\
&\geq \frac{\gamma}{4(h+v)}.
\end{align}
%
%TODO write number of iterations in better form when done with the proof.
\begin{codeblock}
  \textbf{Algorithm: FindHash}$(h, v, \gamma, n, k)$
  \medskip
  \hrule
  \medskip
  \textbf{Oracle:} A problem poser $P^{(g)}$, a solver circuit $C$ for $P^{(g)}$.\\
  \textbf{Input:} Parameters $ h,v,\gamma, n, k$\\
  \textbf{Output:} A function $hash:Q \rightarrow \{0,1, \dots, 2(h+v)-1 \}$.
  \medskip\hrule\medskip
  Let $\cH$ be a family of pairwise independent hash functions $Q \rightarrow \{0,1,\dots, 2(h+v)-1\}$\\
  \For $i = 1$ \To $32(h+v)^2/\gamma^2$ \Do \\
  \IndI $hash \xleftarrow{\$} \cH$ \\
  \IndI $count := 0$ \\
  \IndI \For $j := 1$ to $32(h+v)^2/\gamma^2$ \Do \\
  \IndII $\pi^{(k)} \xleftarrow{\$} \{0,1\}^{kn} $\\
  \IndII $\rho \xleftarrow{\$} \{0,1\}^*$ \\
  \IndII \If $CanonicalSuccess^{P^{(g)}, C, hash}(\pi^{(k)}, \rho) = 1$ \then \\
  \IndIII $count := count + 1$\\
  \IndI \If $\frac{\gamma^2}{32(h+v)^2} count \geq \frac{\gamma}{6(h+v)}$ \then \\
  \IndII \return $hash$\\
  \return $\bot$
\end{codeblock}
We show that \textbf{FindHash} chooses $hash$ such
that the canonical success probability of $C$
with respect to $P_{hash}$ is at least $\frac{\gamma}{4(h+v)}$ almost surely.
Let $\cH_{Good}$ denote a family of functions $hash \in \cH$ for which
\begin{align}
  \label{eq:hash_good}
\underset{\pi^{(k)}, \rho}{\Pr}\left[CanonicalSuccess^{P^{(g)}, C, hash}(\pi^{(k)}, \rho) = 1\right] \geq \frac{\gamma}{4(h+v)},
\end{align}
and $\cH_{Bad}$ be the family of functions $hash \in \cH$ such that
\begin{align}
  \label{eq:hash_bad}
\underset{\pi^{(k)}, \rho}{\Pr}\left[CanonicalSuccess^{P^{(g)}, C^{(\cdot, \cdot)}, hash}(\pi^{(k)}, \rho) = 1\right] \leq \frac{\gamma}{8(h+v)}.
\end{align}

Let $N := 32(h+v)^2/\gamma^2$ be the number of iterations of the inner loop of \textbf{FindHash}.
For a fixed $hash$, we define binary random variables $X_1, \dots, X_{N}$ such that
\begin{align*}
  X_i =
  \begin{cases}
    1 & \text{if in the $i$-th iteration of the inner loop $count$ is increased}\\
    0 & \text{otherwise.}
  \end{cases}
\end{align*}
We show now that \textbf{FindHash} is unlikely to return $hash \in \cH_{Bad}$.
For $hash \in \cH_{Bad}$ by (\ref{eq:hash_bad}) we have $\mathbb{E}_{\pi^{(k)},\rho}[X_i] \leq \frac{\gamma}{8(h+v)}$.
Therefore, for any fixed $hash \in \cH_{Bad}$ using the Chernoff bound we get
\begin{align*}
  \underset{\pi^{(k)},\rho}{\Pr} \left[\frac{1}{N} \sum_{i=1}^{N} X_i \geq \frac{\gamma}{6(h+v)} \right] \leq
  \underset{\pi^{(k)}, \rho}{\Pr}\left[\frac{1}{N} \sum_{i=1}^{N} X_i \geq (1 + \frac{1}{3}) \mathbb{E}[X_i]\right] \leq
  e^{-{\frac{\gamma}{8(h+v)}} N /27} = e^{-\frac{4}{27}\frac{(h+v)}{\gamma}}.
\end{align*}
%
The probability that $hash \in \cH_{Good}$, when picked, is not returned amounts
\begin{align*}
  \underset{\pi^{(k)}, \rho}{\Pr}\left[\frac{1}{N} \sum_{i=1}^{N} X_i \leq \frac{\gamma}{6(h+v)}\right] \leq
  \underset{\pi^{(k)}, \rho}{\Pr}\left[\frac{1}{N} \sum_{i=1}^{N} X_i \leq (1 - \frac{1}{3})\mathbb{E}[X_i]\right]
  \leq e^{-{\frac{\gamma}{4(h+v)}} N / 18} = e^{-\frac{4}{9} \frac{(h+v)}{\gamma}}.
\end{align*}
%
Finally, we show that \textbf{FindHash} picks in one of its iteration $hash \in \cH_{Good}$ almost surely.
Let $Y_i$ be a binary random variable such that
\begin{align*}
  Y_i =
  \begin{cases}
    1 & \text{if in the $i$-th iteration of the outer loop $hash \in \cH_{Good}$ is picked} \\
    0 & \text{otherwise.}
  \end{cases}
\end{align*}
From equation (\ref{ineq:hash_high_prob}) we know that $\underset{hash \leftarrow \cH}{\Pr}[Y_i = 1] = \mathbb{E}[Y_i] \geq \frac{\gamma}{4(h+v)}$, almost surely.
Thus, we get
\begin{align*}
  \underset{hash \leftarrow \cH}{\Pr}\left[\sum_{i=1}^{K} Y_i = 0\right] &\leq \left(1 - \frac{\gamma}{4(h+v)}\right)^{K} \leq e^{-\frac{\gamma}{4(h+v)} K}
  = e^{-\frac{8(h+v)}{\gamma}}.
\end{align*}
\end{proof}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../master"
%%% End:
